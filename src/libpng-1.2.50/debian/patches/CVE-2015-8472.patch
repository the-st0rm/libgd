Description: fix overflows in png_handle_zTXt(), png_handle_sPLT(),
 png_handle_pCAL(), and png_set_PLTE()
Origin: upstream, https://github.com/glennrp/libpng/commit/7e1ca9ceba4e64259863efdd98bab9b55bdc0b9c
Origin: upstream, https://github.com/glennrp/libpng/commit/4488a96126bbefda51d07835411d8e847a88b2b7
Origin: upstream, https://github.com/glennrp/libpng/commit/ad224c6907e8a274f2679eae4c2e3085fdc7e8c8
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=807112

Index: libpng-1.2.51/pngrutil.c
===================================================================
--- libpng-1.2.51.orig/pngrutil.c	2015-12-18 09:22:17.000000000 -0500
+++ libpng-1.2.51/pngrutil.c	2015-12-18 09:48:37.809065205 -0500
@@ -1111,7 +1111,7 @@
    /* There should be at least one zero (the compression type byte)
     * following the separator, and we should be on it
     */
-   if ( profile >= png_ptr->chunkdata + slength - 1)
+   if (slength < 1U ||  profile >= png_ptr->chunkdata + slength - 1U)
    {
       png_free(png_ptr, png_ptr->chunkdata);
       png_ptr->chunkdata = NULL;
@@ -1239,7 +1239,8 @@
    ++entry_start;
 
    /* A sample depth should follow the separator, and we should be on it  */
-   if (entry_start > (png_bytep)png_ptr->chunkdata + slength - 2)
+   if (slength < 2U ||
+       entry_start > (png_bytep)png_ptr->chunkdata + slength - 2U)
    {
       png_free(png_ptr, png_ptr->chunkdata);
       png_ptr->chunkdata = NULL;
@@ -1713,7 +1714,7 @@
 
    /* We need to have at least 12 bytes after the purpose string
       in order to get the parameter information. */
-   if (endptr <= buf + 12)
+   if (slength < 12U || endptr - buf <= 12)
    {
       png_warning(png_ptr, "Invalid pCAL data");
       png_free(png_ptr, png_ptr->chunkdata);
@@ -2169,7 +2170,7 @@
       /* Empty loop */ ;
 
    /* zTXt must have some text after the chunkdataword */
-   if (text >= png_ptr->chunkdata + slength - 2)
+   if (slength < 2U || text >= png_ptr->chunkdata + slength - 2U)
    {
       png_warning(png_ptr, "Truncated zTXt chunk");
       png_free(png_ptr, png_ptr->chunkdata);
@@ -2295,7 +2296,7 @@
     * keyword
     */
 
-   if (lang >= png_ptr->chunkdata + slength - 3)
+   if (slength < 3U || lang >= png_ptr->chunkdata + slength - 3U)
    {
       png_warning(png_ptr, "Truncated iTXt chunk");
       png_free(png_ptr, png_ptr->chunkdata);
Index: libpng-1.2.51/pngset.c
===================================================================
--- libpng-1.2.51.orig/pngset.c	2015-12-18 09:22:17.000000000 -0500
+++ libpng-1.2.51/pngset.c	2015-12-18 09:48:40.793095873 -0500
@@ -453,8 +453,8 @@
    if (png_ptr == NULL || info_ptr == NULL)
       return;
 
-   max_palette_length = (png_ptr->color_type == PNG_COLOR_TYPE_PALETTE) ?
-      (1 << png_ptr->bit_depth) : PNG_MAX_PALETTE_LENGTH;
+   max_palette_length = (info_ptr->color_type == PNG_COLOR_TYPE_PALETTE) ?
+      (1 << info_ptr->bit_depth) : PNG_MAX_PALETTE_LENGTH;
 
    if (num_palette < 0 || num_palette > (int) max_palette_length)
    {
